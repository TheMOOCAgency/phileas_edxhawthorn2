<%!
  import json
  from django.utils.translation import ugettext as _
  from openedx.core.djangolib.js_utils import dump_js_escaped_json
%>
<%inherit file="../main.html" />
<%
  course_discovery_enabled = settings.FEATURES.get('ENABLE_COURSE_DISCOVERY')
%>

<%namespace name='static' file='../static_content.html'/>

% if course_discovery_enabled:
<%block name="header_extras">
  % for template_name in ["course_card", "filter_bar", "filter", "facet", "facet_option"]:
  <script type="text/template" id="${template_name}-tpl">
      <%static:include path="discovery/${template_name}.underscore" />
  </script>
  % endfor
  <%static:require_module module_name="js/discovery/discovery_factory" class_name="DiscoveryFactory">
    DiscoveryFactory(
      ${course_discovery_meanings | n, dump_js_escaped_json},
      getParameterByName('search_query'),
      "${user_language}",
      "${user_timezone}"
    );
  </%static:require_module>
</%block>
% endif

<%block name="pagetitle">${_("Courses")}</%block>

<!-- TMA GLOBAL STYLE -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:300,500" rel="stylesheet">
<link rel="stylesheet" href="${static.url('tma-static/css/courses-tma-custom.css')}">
<link rel="stylesheet" href="${static.url('tma-static/css/global-tma-custom.css')}">
<link rel="stylesheet" href="${static.url('tma-static/css/catalog-course-card.css')}">

<div class="container-fluid" style="padding-bottom: 150px;">
  <div class="row p-5">
    <div class="col">
      <h1 id="search-message">${_("Search results")}</h1>
      <div class="dropdown-container">
        <button>${_("Filter")}<img src="${static.url('tma-static/images/flechebas.svg')}"></button>
        <ul class="dropdown">
          <li value="2"><a href="/courses/?filter=likes">${_("Highest rated")}</a><div class="separator"></div></li>
          <li value="3"><a href="/courses/?filter=enrollments">${_("Most subscribed")}</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-3 pr-0 pl-5">
      <div class="container-fluid criteria-box p-4">
        <div class="row"><h3 class="col text-center mb-4 w-100">${_("Search filters")}</h1></div>
        <div class="row">
          <form class="text-center mb-5">
            <input class="col-10" type="text" name="search" placeholder='${_("Search for a course")}'>
            <button class="col-2" id="course-search"></button>
          </form>
        </div>
        <!-- GENERIC FILTERS -->
        <div class="row">
          <div class="col">
            <!-- title -->
            <div class="container-fluid pl-0 pb-2">
                <div class="row">
                  <div class="col-10"><h4 class="header-facet">${_("All")}</h4></div>
                  <div class="col-2"><span class="count">${len(final_course_list)}</span></div>
                </div>
            </div>
          </div>
        </div>
        <div class="separator"></div>
        <div class="row">
          <div class="col">
            <!-- title -->
            <div class="container-fluid pl-0 pb-2">
                <div class="row">
                  <div class="col-10"><h4 class="header-facet">${_("New")}</h4></div>
                  <div class="col-2"><span class="count">${len(final_course_list)}</span></div>
                </div>
            </div>
          </div>
        </div>
        <div class="separator"></div>
        <!--FILTER LANGUAGES-->
        <div class="row">
          <div class="col">
            <!-- title -->
            <div class="container-fluid pl-0 pb-2">
                <div class="row">
                  <div class="col-10"><h4 class="header-facet">${_("Languages")}</h4></div>
                  <div class="col-2"><span class="count">${len(final_course_list)}</span></div>
                </div>
            </div>
            <div class="container-fluid">
                % for language, count in language_counters.items():
                  <div class="row">
                    <div class="col-10"><a href=""><p class="facet-option text-uppercase">${language}</p></a></div>
                    <div class="col-2"><span class="count">${count}</span></div>
                  </div>
                % endfor
            </div>
          </div>
        </div>
        <div class="separator"></div>
        <!--FILTER TAGS-->
        <div class="row">
          <div class="col">
            <!-- title -->
            <div class="container-fluid pl-0 pb-2">
                <div class="row">
                  <div class="col-10"><h4 class="header-facet">${_("Subjects")}</h4></div>
                  <div class="col-2 pr-0"><span class="count">${len(final_course_list)}</span></div>
                </div>
            </div>
            <div class="container-fluid">
              % for tag in tag_counters:
                % if not 'False' in tag[0]:
                  <div class="row">
                    <div class="col-10"><a href=""><p class="facet-option">${tag[0]}</p></a></div>
                    <div class="col-2"><span class="count">${tag[1]}</span></div>
                  </div>
                % endif
              % endfor
            </div>
          </div>
        </div>
        <div class="separator"></div>
        <!--FILTER ORG-->
        <div class="row">
          <div class="col">
            <div class="container-fluid pl-0 pb-2">
              % for org, count in org_counters.items():
                <div class="row">
                  <div class="col-10"><a href=""><h4 class="header-facet">${org}</h4></a></div>
                  <div class="col-2 pr-0"><span class="count">${count}</span></div>
                </div>
              % endfor
            </div>
          </div>
        </div>
      </div>
      </div>
      <div class="col-lg-9 pl-0 pr-5">
        <div class="container-fluid">
          <div id="cards-box" class="row">
            % for course in final_course_list:
              <%include file='../tma_apps/catalog_course_card.html' args='course=course' />
            % endfor
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="${static.url('tma-static/js/dashboard-tma-actions.js')}" charset="utf-8"></script>
<script src="${static.url('tma-static/js/likes-and-favorite.js')}" charset="utf-8"></script>
<script src="${static.url('tma-static/js/course-search.js')}" charset="utf-8"></script>
<script>
  $(document).ready(function(){
    // Resize cols and cards for search page 
    $('.flip-container').removeClass('col-lg-3').addClass('col-lg-4 pr-0');
    $('.course-card-sm, .flip-container').css('margin-bottom', '15px');

    var coursesJson = ${json_courses | n, dump_js_escaped_json};

    /* SEARCH QUERY */
    var query;
    var results;
    // From input
    $('#course-search').on('click', function(e) {
      e.preventDefault();
      query = $('input[name="search"]').val();
      results = searchQuery(coursesJson, query);
      if (results.length > 0) {
        displayResults(results);
        $('#search-message').html('${_("Search results")}');
      } else {
        displayResults(coursesJson);
        $('#search-message').html('${_("No results found")}');
      }
      flipEffect();
    });
    // From filters
    $('.facet-option').on('click', function(e){
      e.preventDefault();
      query = $(this).text();
      console.log(query)
      results = searchQuery(coursesJson, query);
      displayResults(results);
      flipEffect();
    });
  });
</script>