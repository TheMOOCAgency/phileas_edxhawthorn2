<%!
  import json
  from django.utils.translation import ugettext as _
  from openedx.core.djangolib.js_utils import dump_js_escaped_json
%>
<%inherit file="../main.html" />
<%
  course_discovery_enabled = settings.FEATURES.get('ENABLE_COURSE_DISCOVERY')
%>

<%namespace name='static' file='../static_content.html'/>

% if course_discovery_enabled:
<%block name="header_extras">
  % for template_name in ["course_card", "filter_bar", "filter", "facet", "facet_option"]:
  <script type="text/template" id="${template_name}-tpl">
      <%static:include path="discovery/${template_name}.underscore" />
  </script>
  % endfor
  <%static:require_module module_name="js/discovery/discovery_factory" class_name="DiscoveryFactory">
    DiscoveryFactory(
      ${course_discovery_meanings | n, dump_js_escaped_json},
      getParameterByName('search_query'),
      "${user_language}",
      "${user_timezone}"
    );
  </%static:require_module>
</%block>
% endif

<%block name="pagetitle">${_("Courses")}</%block>

<!-- TMA GLOBAL STYLE -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:300,500" rel="stylesheet">
<link rel="stylesheet" href="${static.url('tma-static/css/courses-tma-custom.css')}">
<link rel="stylesheet" href="${static.url('tma-static/css/global-tma-custom.css')}">
<link rel="stylesheet" href="${static.url('tma-static/css/catalog-course-card.css')}">

<div class="container-fluid" style="padding-bottom: 150px;">
  <div class="row p-5">
    <div class="col">
      <h1 id="search-message">${_("Search results")}</h1>
      <div class="dropdown-container">
        <button>${_("Filter")}<img src="${static.url('tma-static/images/flechebas.svg')}"></button>
        <ul class="dropdown">
          <li value="2"><a href="">${_("Highest rated")}</a><div class="separator"></div></li>
          <li value="3"><a href="">${_("Most subscribed")}</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-3">
      <div class="container-fluid criteria-box">
        <div class="row">
          <h3 class="text-center mt-4 mb-4 w-100">${_("Search filters")}</h1>
          <form class="text-center w-100 mb-5">
            <input type="text" name="search" placeholder='${_("Search for a course")}'>
            <button id="course-search"></button>
          </form>
        </div>
        <!--FILTER-->
        <div class="row">
          <div class="col">
            <h4 class="header-facet">${_("Languages")}</h4>
            <div class="container-fluid">
                % for language, count in language_counters.items():
                  <div class="row">
                    <div class="col-10"><a href="/courses/?search=${language}"><p class="facet-option text-uppercase">${language}</p></a></div>
                      <div class="col-2"><span class="count">${count}</span></div>
                  </div>
                % endfor
            </div>
          </div>
        </div>
        <div class="separator"></div>
        <!--FILTER-->
        <div class="row">
          <div class="col">
            <h4 class="header-facet">${_("Subjects")}</h4>
            <div class="container-fluid">
              % for tag in tag_counters:
                % if not 'False' in tag[0]:
                  <div class="row">
                    <div class="col-10"><a href="/courses/?search=${tag[0]}"><p class="facet-option">${tag[0]}</p></a></div>
                    <div class="col-2"><span class="count">${tag[1]}</span></div>
                  </div>
                % endif
              % endfor
            </div>
          </div>
        </div>
        </div>
      </div>
      <div class="col-lg-9">
        <div class="container-fluid">
          <div id="cards-box" class="row">
            % for course in final_course_list:
              <%include file='../tma_apps/catalog_course_card.html' args='course=course' />
            % endfor
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="${static.url('tma-static/js/dashboard-tma-actions.js')}" charset="utf-8"></script>
<script src="${static.url('tma-static/js/likes-and-favorite.js')}" charset="utf-8"></script>
<script src="${static.url('tma-static/js/course-search.js')}" charset="utf-8"></script>
<script>
  $(document).ready(function(){
    // Resize cols for search page 
    $('.flip-container').removeClass('col-lg-3').addClass('col-lg-4');

    var coursesJson = ${json_courses | n, dump_js_escaped_json};
    console.log(coursesJson)

    /* SEARCH QUERY */
    var query;
    var results;
    // From input
    $('#course-search').on('click', function(e) {
      e.preventDefault();
      query = $('input[name="search"]').val();
      results = searchQuery(coursesJson, query);
      if (results.length > 0) {
        displayResults(results);
        $('#search-message').html('${_("Search results")}');
      } else {
        displayResults(coursesJson);
        $('#search-message').html('${_("No results found")}');
      }
      flipEffect();
    });
    // From filters
    $('.facet-option').on('click', function(e){
      e.preventDefault();
      query = $(this).text();
      console.log(query)
      results = searchQuery(coursesJson, query);
      displayResults(results);
      flipEffect();
    });

     
    // Favorite and like 
    /*
    $('#cards-box').on('click', '.pin.favorite', function(){
      let update_info = change_social_attributes($(this), 'favorite');
      console.log(update_info)
    });
    */
    
  });
</script>