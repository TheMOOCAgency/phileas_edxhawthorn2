<%page expression_filter="h"/>
<%inherit file="main.html" />
<%def name="online_help_token()"><% return "learnerdashboard" %></%def>
<%namespace name='static' file='static_content.html'/>
<%!
import pytz
import re
from datetime import datetime, timedelta
from django.urls import reverse
from django.utils.translation import ugettext as _
from django.template import RequestContext
from entitlements.models import CourseEntitlement
from third_party_auth import pipeline
from util.date_utils import strftime_localized
from opaque_keys.edx.keys import CourseKey
from openedx.core.djangoapps.content.course_overviews.models import CourseOverview
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import HTML, Text
from student.models import CourseEnrollment
from lms.djangoapps.courseware.courses import (
  get_course_overview_with_access,
  get_course
)
from lms.djangoapps.tma_apps.vodeclic.vodeclic import get_vodeclic_href
from lms.djangoapps.tma_apps.models import TmaCourseOverview
%>

<%
  cert_name_short = settings.CERT_NAME_SHORT
  cert_name_long = settings.CERT_NAME_LONG
%>


<%block name="pagetitle">${_("Dashboard")}</%block>
<%block name="bodyclass">view-dashboard is-authenticated</%block>

<%block name="header_extras">
% for template_name in ["donation"]:
<script type="text/template" id="${template_name}-tpl">
  <%static:include path="dashboard/${template_name}.underscore" />
</script>
% endfor
</%block>

<%block name="js_extra">
  <script src="${static.url('js/commerce/credit.js')}"></script>
  <%static:js group='dashboard'/>
  <script type="text/javascript">
    $(document).ready(function() {
      edx.dashboard.legacy.init({
        dashboard: "${reverse('dashboard') | n, js_escaped_string}",
        signInUser: "${reverse('signin_user') | n, js_escaped_string}",
        changeEmailSettings: "${reverse('change_email_settings') | n, js_escaped_string}"
      });
    });
  </script>
  <%static:webpack entry="UnenrollmentFactory">
    UnenrollmentFactory({
      urls: {
        dashboard: "${reverse('dashboard') | n, js_escaped_string}",
        signInUser: "${reverse('signin_user') | n, js_escaped_string}",
        changeEmailSettings: "${reverse('change_email_settings') | n, js_escaped_string}",
        browseCourses: "${marketing_link('COURSES') | n, js_escaped_string}"
      },
      isEdx: false
    });
  </%static:webpack>
  <%static:webpack entry="EntitlementUnenrollmentFactory">
    ## Wait until the document is fully loaded before initializing the EntitlementUnenrollmentView
    ## to ensure events are setup correctly.
    $(document).ready(function() {
      EntitlementUnenrollmentFactory({
        dashboardPath: "${reverse('dashboard') | n, js_escaped_string}",
        signInPath: "${reverse('signin_user') | n, js_escaped_string}",
        browseCourses: "${marketing_link('COURSES') | n, js_escaped_string}",
        isEdx: false
      });
    });
  </%static:webpack>
  % if settings.FEATURES.get('ENABLE_DASHBOARD_SEARCH'):
    <%static:require_module module_name="course_search/js/dashboard_search_factory" class_name="DashboardSearchFactory">
        DashboardSearchFactory();
    </%static:require_module>
  % endif
  % if redirect_message:
    <%static:require_module module_name="js/views/message_banner" class_name="MessageBannerView">
        var banner = new MessageBannerView({urgency: 'low', type: 'warning'});
        $('#content').prepend(banner.$el);
        banner.showMessage(${redirect_message | n, dump_js_escaped_json})
    </%static:require_module>
  % endif
</%block>

<!-- TMA enable BOOTSTRAP-->
<link rel="stylesheet" type="text/css" href="${static.url('css/bootstrap/lms-main.css')}">
<script type="text/javascript" src="${static.url('common/js/vendor/bootstrap.bundle.js')}"></script>
<!-- TMA GLOBAL STYLE -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:300,500" rel="stylesheet">
<link rel="stylesheet" href="${static.url('tma-static/css/global-tma-custom.css')}">
<link rel="stylesheet" href="${static.url('tma-static/css/dashboard-tma-custom.css')}">
<link rel="stylesheet" href="${static.url('tma-static/css/likes-and-favorite.css')}">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@8.0.1/dist/sweetalert2.all.min.js"></script>
<div class="dashboard-notifications" tabindex="-1">



    %if banner_account_activation_message:
        <div class="dashboard-banner">
            ${banner_account_activation_message | n, decode.utf8}
        </div>
    %endif

    %if enrollment_message:
        <div class="dashboard-banner">
            ${enrollment_message | n,  decode.utf8}
        </div>
    %endif

    %if enterprise_message:
        <div class="dashboard-banner">
            ${ enterprise_message | n, decode.utf8 }
        </div>
    %endif

    %if account_activation_messages:
      <div class="activation-message-container">
        % for account_activation_message in account_activation_messages:
          <div class="account-activation ${account_activation_message.tags}" role="alert" aria-label="Account Activation Message" tabindex="-1">
            <div class="message-copy" >
              ${ account_activation_message | n, decode.utf8 }
            </div>
          </div>
        % endfor
      </div>
    %endif

</div>

<div class="container-fluid bg-grey-light">
  <!--PRESENTATION ROW-->
  <div class="row bg-white">
      <form method="get" action="/courses" class="gif-box">
        <p class="title-36">Find your course <br>among
          <span class="numscroller" data-min='1' data-max='130' data-delay='5' data-increment='10'>130</span>
           available
        </p>
        <div class="search-field-wrapper">
          <button type="submit" class="search-button btn" title="${_('Search')}">
            <img src="${static.url('tma-static/images/loupe.svg')}" style="width:30px">
          </button>
          <input name="search_query" id="dashboard-search-input" type="text" class="search-input" placeholder="What do you want to learn?"/>
          <!--<button type="button" class="cancel-button" title="${_('Clear search')}">
            <span class="icon fa fa-remove" aria-hidden="true"></span>
          </button>-->
        </div>
      </form>
      <video autoplay="true" class="embed-responsive-item" height="420" loop muted>
        <source src="${static.url('tma-static/video/hp_femme_comp.mp4')}" type="video/mp4">
      </video>
    <!--Black & White img-->
    <div class="zoomEffect col-lg-3 text-center img-bw-1">
      <a href="${sspeaking_url}" target="_blank">Language <br>skills</a>
    </div>
    <div class="zoomEffect col-lg-3 text-center img-bw-2">
        <a href="#">Regulatory<br> (eCampus)</a>
    </div>
    % if language == 'fr':
    <div class="zoomEffect col-lg-3 text-center img-bw-3">
        <a href="https://www.e-exercises.com/speakingtime/07cdfd23373b17c6b337251c22b7ea57">Get <br> together</a>
    </div>
    %else:
    <div class="zoomEffect col-lg-3 text-center img-bw-3">
        <a href="#">US <br>regulatory courses</a>
    </div>
    %endif
    <!--User dark blue box-->
    <div class="col-lg-3 bg-blue-dark user-box text-white">
      <div class="container-fluid">
        <div class="row">
            <div class="col-12 mb-3">
              <p class="text-blue-light">${_("Last course")}</p>
              % if course_enrollments:
                <p class="last-course-title" onclick="window.location.href = '/courses/${course_enrollments[-1].course_id}/courseware';">${course_enrollments[-1].course_overview.display_name_with_default}<img class="m-1 ml-3" src="${static.url('tma-static/images/fleche-dr-blanc.svg')}"></p>
              % else:
                <p>${_("No enrollment yet")}<img class="m-1 ml-3" src="${static.url('tma-static/images/fleche-dr-blanc.svg')}"></p>
              % endif
              <div class="separator"></div>
            </div>
        </div>
      <a id="tma_counter_link" href="/tma_apps/dashboard/home/">
        <div class="row">
          <div class="col-4 text-center white-right-border">
            <p>
               <span class="numscroller tma_course_counters" data-min='1' data-max='${mandatory_courses_count}' data-delay='1' data-increment='${mandatory_courses_count/3}'>${mandatory_courses_count}</span>
               <img src="${static.url('tma-static/images/warning.svg')}">
            </p>
            <p class="mt-2 tma_course_counters_label">mandatory course(s)</p>
          </div>
          <div class="col-4 text-center white-right-border">
            <p id="fav-counter" class="tma_course_counters">
               <!--<span class="numscroller tma_course_counters" data-min='1' data-max='${favorite_courses_count}' data-count="${favorite_courses_count}" data-delay='1' data-increment='${favorite_courses_count/3}'>${favorite_courses_count}</span>-->
               <span id="favorite-counter-number">${favorite_courses_count}</span>
               <img src="${static.url('tma-static/images/etoile.svg')}"/>
            </p>
            <p class="mt-2 tma_course_counters_label">favorite course(s)</p>
          </div>
          <div class="col-4 text-center">
            <p>
              <span class="tma_course_counters" class="numscroller" data-min='1' data-max='${ongoing_courses_count}' data-delay='1' data-increment='${ongoing_courses_count/3}'>${ongoing_courses_count}</span>
              <img src="${static.url('tma-static/images/drapeau.svg')}"/>
            </p>
            <p class="mt-2 tma_course_counters_label">ongoing course(s)</p>
          </div>
        </div>
      </a>
      </div>
    </div>
  </div>

  <!--COURSES DISPLAY-->
  <div class="container-fluid">
    <!--Title and filter-->
    <div class="row mt-3 mb-3">
      <div class="col-lg-10 title-col">
        <h1>Our Selection</h1>
      </div>
      <div class="col-lg-2">
        <div class="dropdown-container">
          <button onclick="Swal.fire('Not yet implemented !','Thank you for your understanding','info');">Filter<img src="${static.url('tma-static/images/flechebas.svg')}"></button>
          <ul class="dropdown">
            <li value="1"><a href="">The front page</a><div class="separator"></div></li>
            <li value="2"><a href="">Highest rated</a><div class="separator"></div></li>
            <li value="3"><a href="">Most subscribed</a></li>
          </ul>
        </div>
      </div>
    </div>




    <!--Course cards--------------------------------------------------------------------------------------->

    <!-- First row -->
    <div class="row">
      <!-- First two courses -->
      % if final_course_list :
        %for course in final_course_list[:2] :
          <%include file='tma_apps/catalog_course_card.html' args='course=course' />
        %endfor
      %endif
      <!-- First static double card -->
      <div class="col-lg-6">
          <a href="https://www.moncompteactivite.gouv.fr/cpa-public/mes-droits-formation/mon-cpf-compte-personnel-de-formation/decouvrir-le-cpf" target="_blank"><div class="static-card"></div></a>
      </div>
    </div>

    <!-- Second row -->
    <div class="row">
      <!-- Second two courses -->
      % if final_course_list :
        %for course in final_course_list[2:4] :
          <%include file='tma_apps/catalog_course_card.html' args='course=course' />
        %endfor
      %endif
      <!-- Second static double card -->
        <%include file='tma_apps/double_course_card.html' args='course=final_course_list[4]' />
    </div>

    <!-- Third Row -->
    <div class="row">
      % if final_course_list :
        %for course in final_course_list[4:8] :
          <%include file='tma_apps/catalog_course_card.html' args='course=course' />
        %endfor
      %endif
    </div>

    <!--CATEGORIES-->
    <div class="container-fluid bg-grey-light">
      <div class="row mb-5">
          <div class="col text-center more-btn">
            <a href="/courses"><img src="${static.url('tma-static/images/+.svg')}"></a>
          </div>
      </div>
      <div class="row mt-3">
          <div class="col">
            <h1>Categories</h1>
          </div>
      </div>
      <div class="row categories">
        <div class="zoomEffect col-lg-4 text-center cat-1"><a href="#">Software</a></div>
        <div class="zoomEffect col-lg-4 text-center cat-2"><a href="#">Business basics</a></div>
        <div class="zoomEffect col-lg-4 text-center cat-3">
          <a href="#">Business applications</a>
        </div>
        <div class="zoomEffect col-lg-4 text-center cat-4">
          <a href="#">Marketing and communication</a>
        </div>
        <div class="zoomEffect col-lg-4 text-center cat-5">
          <a href="#">Compliance</a>
        </div>
        <div class="zoomEffect col-lg-4 text-center cat-6">
          <a href="#">Management</a>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- TMA DASHBORD SCRIPT-->
<script>
  let etoile_src="${static.url('tma-static/images/etoile.svg')}"
  let counter = ${favorite_courses_count}
</script>
<script src="${static.url('tma-static/js/dashboard-tma-actions.js')}" charset="utf-8"></script>
<script src="${static.url('tma-static/js/likes-and-favorite.js')}" charset="utf-8"></script>
